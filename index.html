  <script>
    const API_URL = "https://epaa-cv-praktikum-aiko.hf.space/predict";

    const video = document.getElementById("video");
    const overlayCanvas = document.getElementById("overlayCanvas");
    const ctxOverlay = overlayCanvas.getContext("2d");

    const btnToggleCam = document.getElementById("btnToggleCam");
    const btnFront = document.getElementById("btnFront");
    const btnBack = document.getElementById("btnBack");
    const btnDetect = document.getElementById("btnDetect");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const errorBox = document.getElementById("errorBox");
    const summaryBox = document.getElementById("summary");
    const detList = document.getElementById("detList");
    const lastTime = document.getElementById("lastTime");

    let currentStream = null;
    let cameraOn = false;
    let busy = false;

    // Deteksi sederhana: mobile vs desktop
    const isMobile =
      /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ||
      (window.innerWidth < 768);

    // Di HP default kamera belakang, di laptop default webcam / depan
    let currentFacing = isMobile ? "environment" : "user";

    function setStatus({ live = false, text = "" }) {
      statusDot.classList.toggle("live", live);
      statusText.textContent = text;
    }

    function setError(msg) {
      if (!msg) {
        errorBox.style.display = "none";
        errorBox.textContent = "";
      } else {
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }
    }

    function resizeOverlay() {
      if (!video.videoWidth || !video.videoHeight) return;
      overlayCanvas.width = video.videoWidth;
      overlayCanvas.height = video.videoHeight;
    }

    function updateButtons() {
      btnDetect.disabled = !cameraOn || busy;
      btnToggleCam.disabled = busy;
      if (!cameraOn) {
        btnToggleCam.textContent = "üé• Nyalakan Kamera";
      } else {
        btnToggleCam.textContent = "‚èπ Matikan Kamera";
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach((t) => t.stop());
        currentStream = null;
      }
      cameraOn = false;
      video.srcObject = null;
      // Hapus overlay
      ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      setStatus({ live: false, text: "Kamera dimatikan" });
      updateButtons();
    }

    async function startCamera(facing = currentFacing) {
      setError("");
      currentFacing = facing;

      try {
        busy = true;
        updateButtons();
        setStatus({ live: false, text: "Mengaktifkan kamera..." });

        // Matikan stream sebelumnya
        if (currentStream) {
          currentStream.getTracks().forEach((t) => t.stop());
          currentStream = null;
        }

        // Preferensi resolusi
        const baseVideoConfig = {
          width: { ideal: 1280 },
          height: { ideal: 720 }
        };

        let constraints;

        if (isMobile) {
          // HP: coba dengan facingMode + resolusi
          constraints = {
            video: {
              ...baseVideoConfig,
              facingMode: { ideal: facing } // "environment" atau "user"
            },
            audio: false
          };
        } else {
          // Laptop/PC: cukup video default + resolusi
          constraints = {
            video: baseVideoConfig,
            audio: false
          };
        }

        let stream;
        try {
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
          console.warn("getUserMedia gagal dengan constraints utama: ", err.name, err.message);

          // Fallback: coba config minimal
          constraints = {
            video: true,
            audio: false
          };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        }

        currentStream = stream;
        video.srcObject = stream;

        // Untuk kamera depan di HP / laptop: mirror biar enak lihat wajah
        if (!isMobile || currentFacing === "user") {
          video.style.transform = "scaleX(-1)";
          overlayCanvas.style.transform = "scaleX(-1)";
        } else {
          video.style.transform = "scaleX(1)";
          overlayCanvas.style.transform = "scaleX(1)";
        }

        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            resizeOverlay();
            resolve();
          };
        });

        cameraOn = true;
        const label = isMobile
          ? facing === "environment"
            ? "belakang"
            : "depan"
          : "webcam";

        setStatus({ live: true, text: `Kamera ${label} aktif ‚Äì siap deteksi` });
      } catch (err) {
        console.error("Error startCamera:", err.name, err.message);
        if (err.name === "NotAllowedError" || err.name === "SecurityError") {
          setError(
            "Izin kamera ditolak. Buka pengaturan situs (ikon gembok di address bar) lalu ubah Camera ‚Üí Allow."
          );
        } else if (err.name === "NotFoundError") {
          setError("Tidak ada perangkat kamera yang ditemukan di perangkat ini.");
        } else {
          setError(
            "Gagal mengakses kamera: " + err.name + " ‚Äì " + err.message
          );
        }
        setStatus({ live: false, text: "Kamera gagal diaktifkan" });
        cameraOn = false;
        currentStream = null;
      } finally {
        busy = false;
        updateButtons();
      }
    }

    async function handleToggleCamera() {
      setError("");
      if (cameraOn) {
        stopCamera();
      } else {
        await startCamera(currentFacing);
      }
    }

    async function captureAndDetect() {
      if (!cameraOn || !currentStream || busy) return;

      busy = true;
      updateButtons();
      setError("");
      btnDetect.textContent = "Memproses...";
      setStatus({ live: true, text: "Mengirim frame ke server..." });

      try {
        const vw = video.videoWidth || 640;
        const vh = video.videoHeight || 480;

        const captureCanvas = document.createElement("canvas");
        captureCanvas.width = vw;
        captureCanvas.height = vh;
        const cctx = captureCanvas.getContext("2d");
        cctx.drawImage(video, 0, 0, vw, vh);

        const blob = await new Promise((resolve) =>
          captureCanvas.toBlob(resolve, "image/jpeg", 0.9)
        );

        const form = new FormData();
        form.append("file", blob, "frame.jpg");

        const t0 = performance.now();
        const resp = await fetch(API_URL, {
          method: "POST",
          body: form
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error("Server error " + resp.status + " ‚Äì " + text);
        }

        const data = await resp.json();
        const t1 = performance.now();
        renderDetections(data, t1 - t0);
      } catch (err) {
        console.error("Error detect:", err);
        setError("Gagal melakukan deteksi: " + err.message);
        setStatus({ live: cameraOn, text: "Terjadi kesalahan saat deteksi" });
      } finally {
        busy = false;
        btnDetect.textContent = "üîç Deteksi Sekarang";
        updateButtons();
      }
    }

    function renderDetections(result, latencyMs) {
      const dets = result?.detections || [];
      const w = result?.width || video.videoWidth || overlayCanvas.width;
      const h = result?.height || video.videoHeight || overlayCanvas.height;

      overlayCanvas.width = w;
      overlayCanvas.height = h;

      ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

      if (!dets.length) {
        summaryBox.innerHTML =
          "Tidak ada objek terdeteksi pada frame terakhir. Coba ubah posisi kamera atau objek.";
        detList.innerHTML =
          '<div class="empty-state">Tidak ada bounding box yang digambar.</div>';
        setStatus({ live: cameraOn, text: "Deteksi selesai ‚Äì tidak ada objek" });
        lastTime.textContent = new Date().toLocaleTimeString();
        return;
      }

      ctxOverlay.lineWidth = 3;
      ctxOverlay.font = "14px system-ui";
      ctxOverlay.textBaseline = "top";

      detList.innerHTML = "";
      const classCounter = {};

      dets.forEach((det, idx) => {
        const { class_name, confidence, x1, y1, x2, y2 } = det;
        const label = class_name || "object";
        const confPct = (confidence * 100).toFixed(1) + "%";

        const colors = ["#22c55e", "#38bdf8", "#a855f7", "#f97316", "#e11d48"];
        const color = colors[idx % colors.length];

        const bw = x2 - x1;
        const bh = y2 - y1;
        ctxOverlay.strokeStyle = color;
        ctxOverlay.fillStyle = "rgba(15,23,42,0.75)";
        ctxOverlay.strokeRect(x1, y1, bw, bh);

        const labelText = label + " " + confPct;
        const textPaddingX = 4;
        const textPaddingY = 2;
        const textWidth =
          ctxOverlay.measureText(labelText).width + textPaddingX * 2;
        const textHeight = 16 + textPaddingY * 2;

        const tx = Math.max(x1, 0);
        const ty = Math.max(y1 - textHeight, 0);

        ctxOverlay.fillRect(tx, ty, textWidth, textHeight);
        ctxOverlay.fillStyle = "#f9fafb";
        ctxOverlay.fillText(labelText, tx + textPaddingX, ty + textPaddingY);

        const row = document.createElement("div");
        row.className = "det-row";
        row.innerHTML = `
          <div>
            <div class="det-class">${label}</div>
            <div class="det-box">[${x1.toFixed(
              0
            )}, ${y1.toFixed(0)} ‚Üí ${x2.toFixed(0)}, ${y2.toFixed(0)}]</div>
          </div>
          <div class="det-conf">${confPct}</div>
        `;
        detList.appendChild(row);

        classCounter[label] = (classCounter[label] || 0) + 1;
      });

      const total = dets.length;
      const parts = Object.entries(classCounter).map(
        ([cls, count]) => `${count} √ó <strong>${cls}</strong>`
      );

      summaryBox.innerHTML = `
        Terdeteksi <strong>${total}</strong> objek dalam satu frame
        (${parts.join(", ")}).<br/>
        Latensi end-to-end: <strong>${latencyMs.toFixed(0)} ms</strong>.
      `;

      setStatus({
        live: cameraOn,
        text: "Deteksi selesai ‚Äì hasil ditampilkan di layar"
      });
      lastTime.textContent = new Date().toLocaleTimeString();
    }

    // Event listeners
    btnToggleCam.addEventListener("click", handleToggleCamera);
    btnDetect.addEventListener("click", captureAndDetect);

    // Hanya aktif di HP (tombol sudah di-hide di desktop lewat CSS)
    btnFront.addEventListener("click", () => {
      if (!busy) startCamera("user");
    });
    btnBack.addEventListener("click", () => {
      if (!busy) startCamera("environment");
    });

    window.addEventListener("resize", () => {
      if (cameraOn) resizeOverlay();
    });

    // Cek support kamera
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setError(
        "Browser ini belum mendukung akses kamera (getUserMedia). Coba gunakan Chrome atau Edge versi terbaru."
      );
      btnToggleCam.disabled = true;
      btnDetect.disabled = true;
      setStatus({ live: false, text: "Browser tidak mendukung kamera" });
    }
  </script>
</body>
</html>
